generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String    @id @default(cuid())
  email               String?   @unique // Optional for anonymous mobile users
  name                String?
  emailVerified       DateTime?
  image               String?
  stripeCustomerId    String? // set after Stripe customer creation
  credits             Int       @default(15) // initial credits for new users
  showCommunityImages Boolean   @default(false) // parental control for community gallery
  activeProfileId     String? // Currently selected profile
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  subscriptions        Subscription[]
  creditTransactions   CreditTransaction[]
  coloringImages       ColoringImage[]
  savedArtworks        SavedArtwork[] // User's saved colored artwork
  profiles             Profile[] // Multi-profile support for families
  userStickers         UserSticker[] // Collected stickers
  canvasProgress       CanvasProgress[] // Canvas progress for cross-platform sync
  // Auth.js relations
  accounts             Account[]
  sessions             Session[]
  // Mobile device sessions
  mobileDeviceSessions MobileDeviceSession[]

  @@map("users")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String
  user                 User               @relation(fields: [userId], references: [id])
  stripeSubscriptionId String             @unique
  planName             PlanName
  billingPeriod        BillingPeriod
  status               SubscriptionStatus
  currentPeriodEnd     DateTime
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@map("subscriptions")
}

model CreditTransaction {
  id        String                @id @default(cuid())
  userId    String
  user      User                  @relation(fields: [userId], references: [id])
  amount    Int // positive for credit, negative for usage
  type      CreditTransactionType
  reference String? // Stripe payment intent, etc.
  createdAt DateTime              @default(now())

  @@map("credit_transactions")
}

model ColoringImage {
  id              String         @id @default(cuid())
  title           String
  description     String
  alt             String
  url             String?
  svgUrl          String?
  qrCodeUrl       String?
  ambientSoundUrl String? // ElevenLabs generated ambient sound for coloring experience
  tags            String[]
  difficulty      Difficulty? // Optional: BEGINNER, INTERMEDIATE, ADVANCED, EXPERT
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  generationType  GenerationType @default(USER)
  User            User?          @relation(fields: [userId], references: [id])
  userId          String?
  profile         Profile?       @relation(fields: [profileId], references: [id])
  profileId       String? // Which profile created this image
  savedArtworks   SavedArtwork[] // Colored versions saved by users

  // Pre-computed grid-based color map for Magic Brush & Auto Colour (instant reveal)
  colorMapJson        String?   @db.Text // JSON with 5x5 grid color assignments
  colorMapGeneratedAt DateTime? // When the color map was generated

  // Canvas progress for cross-platform sync
  canvasProgress CanvasProgress[]

  @@map("coloring_images")
}

// Canvas progress model for cross-platform synchronization
model CanvasProgress {
  id               String    @id @default(cuid())
  userId           String
  coloringImageId  String
  actions          Json // Serialized drawing actions
  canvasWidth      Int? // Canvas width for aspect ratio (optional for backward compatibility)
  canvasHeight     Int? // Canvas height for aspect ratio (optional for backward compatibility)
  previewUrl       String? // URL to progress thumbnail for feed display
  previewUpdatedAt DateTime? // Track when preview was last updated (throttle updates)
  version          Int       @default(1) // For conflict resolution
  updatedAt        DateTime  @updatedAt
  createdAt        DateTime  @default(now())

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  coloringImage ColoringImage @relation(fields: [coloringImageId], references: [id], onDelete: Cascade)

  @@unique([userId, coloringImageId])
  @@index([userId])
  @@index([coloringImageId])
  @@map("canvas_progress")
}

// Auth.js models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Mobile device session - links device IDs to users for app authentication
model MobileDeviceSession {
  id         String   @id @default(cuid())
  deviceId   String   @unique // Unique device identifier from mobile app
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  lastSeenAt DateTime @default(now()) // Last time device made an API call

  @@map("mobile_device_sessions")
}

// Track processed Stripe webhook events for idempotency
model StripeWebhookEvent {
  id          String   @id // Use Stripe event ID directly
  type        String // Event type (e.g., "invoice.payment_succeeded")
  processedAt DateTime @default(now())

  @@map("stripe_webhook_events")
}

// Profile for multi-child accounts (parents can create profiles for each child)
model Profile {
  id              String     @id @default(cuid())
  userId          String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String // "Emma", "Jack", etc.
  avatarId        String     @default("default") // References avatar SVG
  ageGroup        AgeGroup   @default(CHILD)
  difficulty      Difficulty @default(BEGINNER) // Can be overridden in settings
  isDefault       Boolean    @default(false) // First profile is default
  coloStage       Int        @default(1) // Colo evolution stage (1-6)
  coloAccessories String[]   @default([]) // Unlocked Colo accessories ["astronaut-helmet", "crown"]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  coloringImages    ColoringImage[]
  savedArtworks     SavedArtwork[] // Saved colored artwork for this profile
  userStickers      UserSticker[] // Stickers earned by this profile
  challengeProgress ProfileChallengeProgress[] // Weekly challenge progress

  @@map("profiles")
}

// Saved colored artwork - when users color an image and save it to their gallery
model SavedArtwork {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileId       String?
  profile         Profile?      @relation(fields: [profileId], references: [id])
  coloringImageId String
  coloringImage   ColoringImage @relation(fields: [coloringImageId], references: [id])
  title           String? // Optional custom title (defaults to original image title)
  imageUrl        String // URL of the saved colored artwork (uploaded to cloud storage)
  thumbnailUrl    String? // Optional smaller preview for gallery listing
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Shares for this artwork
  shares ArtworkShare[]

  @@map("saved_artworks")
}

// Shareable link for artwork - allows viewing without authentication
model ArtworkShare {
  id        String       @id @default(cuid())
  artworkId String
  artwork   SavedArtwork @relation(fields: [artworkId], references: [id], onDelete: Cascade)
  shareCode String       @unique // URL-safe random code for sharing
  expiresAt DateTime? // Optional expiration (null = never expires)
  viewCount Int          @default(0)
  isActive  Boolean      @default(true) // Can be deactivated by parent
  createdAt DateTime     @default(now())

  @@map("artwork_shares")
}

// User's collected stickers - unlocked through coloring achievements
model UserSticker {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileId  String? // Which profile earned this sticker (optional)
  profile    Profile? @relation(fields: [profileId], references: [id])
  stickerId  String // References sticker ID from catalog (not a foreign key - stickers are static)
  isNew      Boolean  @default(true) // Shows "NEW!" badge until viewed
  unlockedAt DateTime @default(now())

  // Prevent duplicate stickers per user
  @@unique([userId, stickerId])
  @@map("user_stickers")
}

// Weekly challenge schedule - which challenge is active for which week
model WeeklyChallenge {
  id          String   @id @default(cuid())
  challengeId String // References challenge ID from catalog (static)
  startDate   DateTime // When the challenge starts
  endDate     DateTime // When the challenge ends
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Challenge progress for all profiles
  progress ProfileChallengeProgress[]

  @@map("weekly_challenges")
}

// Profile's progress on a weekly challenge
model ProfileChallengeProgress {
  id                String          @id @default(cuid())
  profileId         String
  profile           Profile         @relation(fields: [profileId], references: [id], onDelete: Cascade)
  weeklyChallengeId String
  weeklyChallenge   WeeklyChallenge @relation(fields: [weeklyChallengeId], references: [id], onDelete: Cascade)
  progress          Int             @default(0) // Current progress count
  completed         Boolean         @default(false)
  completedAt       DateTime?
  rewardClaimed     Boolean         @default(false) // Has the reward been given?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // One progress record per profile per challenge
  @@unique([profileId, weeklyChallengeId])
  @@map("profile_challenge_progress")
}

// Store API tokens that need periodic refresh (e.g., Pinterest OAuth tokens)
model ApiToken {
  id           String   @id @default(cuid())
  provider     String   @unique // e.g., "pinterest", "tiktok"
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  expiresAt    DateTime // When the access token expires
  scopes       String[] // OAuth scopes granted
  metadata     Json? // Any additional provider-specific data
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("api_tokens")
}

enum GenerationType {
  USER
  DAILY
  WEEKLY
  MONTHLY
}

enum Difficulty {
  BEGINNER // Simple shapes, big lines - suitable for toddlers/beginners
  INTERMEDIATE // Moderate detail - suitable for kids
  ADVANCED // Detailed designs - suitable for teens/experienced
  EXPERT // Intricate patterns - suitable for adults
}

enum AgeGroup {
  TODDLER // 2-4 years
  CHILD // 5-8 years
  TWEEN // 9-12 years
  TEEN // 13-17 years
  ADULT // 18+
}

enum PlanName {
  SPLASH
  RAINBOW
  SPARKLE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  INCOMPLETE
  PAST_DUE
  UNPAID
  TRIALING
}

enum CreditTransactionType {
  PURCHASE // user bought credits (one-off or via subscription)
  GENERATION // user spent credits to generate an image
  BONUS // user received bonus credits (promo, referral, etc.)
  REFUND // credits refunded to user
  ADJUSTMENT // manual admin adjustment
}

enum BillingPeriod {
  MONTHLY
  ANNUAL
}
